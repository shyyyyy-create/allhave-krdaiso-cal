<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daiso다이소 다 있어</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
</head>
<body class="bg-gray-50 pb-32">
    <div id="app" class="max-w-md mx-auto min-h-screen relative">
        <nav class="bg-red-600 text-white sticky top-0 z-50 flex justify-around p-3 shadow-lg">
            <button @click="view = 'reg'" :class="{'underline font-bold': view === 'reg'}">登記</button>
            <button @click="view = 'list'" :class="{'underline font-bold': view === 'list'}">產品庫</button>
            <button @click="view = 'plan'" :class="{'underline font-bold': view === 'plan'}">計劃</button>
            <button @click="view = 'cart'" :class="{'underline font-bold': view === 'cart'}">購物籃/歷史</button>
        </nav>

        <section v-if="view === 'reg'" class="p-4">
            <h2 class="text-xl font-bold mb-4 border-l-4 border-red-500 pl-2">產品登記</h2>
            <div class="bg-white p-4 rounded-xl shadow-sm space-y-4">
                <input v-model="form.name" type="text" placeholder="產品名稱" class="w-full border p-2 rounded">
                <select v-model="form.category" class="w-full border p-2 rounded">
                    <option v-for="c in categories" :value="c">{{c}}</option>
                </select>
                <div class="grid grid-cols-3 gap-2">
                    <button v-for="p in priceOptions" @click="form.price = p" 
                        :class="form.price === p ? 'bg-red-500 text-white' : 'bg-gray-100'" class="p-2 rounded border">
                        {{p}}
                    </button>
                </div>
                <input v-model="form.img" type="text" placeholder="圖片鏈結 (URL)" class="w-full border p-2 rounded text-sm">
                <div class="flex gap-2">
                    <button v-for="l in levels" @click="form.level = l"
                        :class="form.level === l ? 'bg-orange-500 text-white' : 'bg-gray-100'" class="flex-1 p-2 rounded border">
                        {{l}}
                    </button>
                </div>
                <div class="border-t pt-2">
                    <p class="text-sm text-gray-500 mb-1">規格 (無上限):</p>
                    <div v-for="(s, idx) in form.specs" :key="idx" class="flex gap-2 mb-1">
                        <input v-model="form.specs[idx]" class="flex-1 border p-1 rounded text-sm">
                        <button @click="form.specs.splice(idx, 1)" class="text-red-500">✕</button>
                    </div>
                    <button @click="form.specs.push('')" class="text-blue-500 text-sm">+ 新增規格</button>
                </div>
                <button @click="saveProduct" class="w-full bg-red-600 text-white py-3 rounded-lg font-bold">確認登記</button>
            </div>
        </section>

        <section v-if="view === 'list'" class="p-4">
            <div class="flex gap-2 mb-4">
                <input v-model="search" placeholder="搜尋..." class="flex-1 border p-2 rounded">
                <select v-model="filterCat" class="border p-2 rounded">
                    <option value="">全分類</option>
                    <option v-for="c in categories" :value="c">{{c}}</option>
                </select>
            </div>
            <div v-for="item in filteredProducts" :key="item.id" class="bg-white p-3 rounded-lg shadow-sm mb-3 flex gap-3">
                <img :src="item.img || 'https://via.placeholder.com/80'" class="w-20 h-20 object-cover rounded">
                <div class="flex-1">
                    <div class="flex justify-between">
                        <span class="font-bold">{{item.name}}</span>
                        <span class="text-xs bg-gray-200 px-1 rounded">{{item.level}}</span>
                    </div>
                    <p class="text-red-600 font-bold">{{item.price}} KRW</p>
                    <div class="mt-2 flex gap-1">
                        <button @click="addToPlanPrompt(item)" class="text-xs bg-blue-500 text-white px-2 py-1 rounded">+計劃</button>
                        <button @click="addToCartPrompt(item)" class="text-xs bg-green-500 text-white px-2 py-1 rounded">+購物籃</button>
                        <button @click="editProduct(item)" class="text-xs border px-2 py-1 rounded">編輯</button>
                    </div>
                </div>
            </div>
        </section>

        <section v-if="view === 'plan'" class="p-4">
            <button @click="createPlan" class="w-full border-2 border-dashed border-gray-400 p-2 rounded mb-4">+ 建立新計劃</button>
            <div v-for="plan in plans" :key="plan.id" class="bg-white p-4 rounded-xl shadow mb-4">
                <div class="flex justify-between items-center mb-2">
                    <input v-model="plan.name" class="font-bold text-lg border-b w-2/3">
                    <button @click="deletePlan(plan.id)" class="text-red-500 text-sm">刪除</button>
                </div>
                <div v-for="(pi, idx) in plan.items" class="flex justify-between text-sm py-1 border-b">
                    <span>{{pi.name}} ({{pi.spec}}) x {{pi.qty}}</span>
                    <div class="flex gap-2">
                        <button @click="pi.qty++">+</button>
                        <button @click="pi.qty > 1 ? pi.qty-- : plan.items.splice(idx,1)">-</button>
                        <button @click="movePlanToCart(plan, pi, idx)" class="text-green-600">加入購物籃</button>
                    </div>
                </div>
            </div>
        </section>

        <section v-if="view === 'cart'" class="p-4">
            <div class="flex gap-2 mb-4">
                <button @click="cartSubView = 'current'" :class="cartSubView === 'current' ? 'bg-red-500 text-white' : 'bg-gray-200'" class="flex-1 py-1 rounded">現時購物籃</button>
                <button @click="cartSubView = 'history'" :class="cartSubView === 'history' ? 'bg-red-500 text-white' : 'bg-gray-200'" class="flex-1 py-1 rounded">購物歷史</button>
            </div>

            <div v-if="cartSubView === 'current'">
                <div v-for="(ci, idx) in cart" class="bg-white p-3 rounded mb-2 flex justify-between items-center shadow-sm">
                    <div>
                        <p class="font-bold">{{ci.name}} <span class="text-xs text-gray-400">{{ci.spec}}</span></p>
                        <p class="text-red-500">{{ci.price * ci.qty}} KRW</p>
                    </div>
                    <div class="flex items-center gap-3">
                        <button @click="ci.qty--" class="bg-gray-200 w-6 rounded">-</button>
                        <span>{{ci.qty}}</span>
                        <button @click="ci.qty++" class="bg-gray-200 w-6 rounded">+</button>
                    </div>
                </div>
                <button v-if="cart.length" @click="checkout" class="w-full bg-black text-white py-3 rounded mt-4">完成結帳並存入歷史</button>
            </div>

            <div v-else>
                <div v-for="h in history" :key="h.id" class="bg-white p-3 rounded mb-3 shadow-sm">
                    <div class="flex justify-between">
                        <input v-model="h.timestamp" class="font-bold">
                        <button @click="deleteHistory(h.id)" class="text-red-400">刪除</button>
                    </div>
                    <p class="text-sm text-gray-500">總額: {{h.total}} KRW</p>
                </div>
            </div>
        </section>

        <div class="p-4 flex gap-2">
            <button @click="exportData" class="flex-1 bg-gray-800 text-white text-xs py-2 rounded">匯出 JSON</button>
            <button @click="clearCache" class="flex-1 bg-gray-400 text-white text-xs py-2 rounded">清除緩存</button>
        </div>

        <div class="fixed bottom-0 left-0 right-0 bg-white border-t-2 border-red-500 p-4 shadow-2xl flex justify-between items-center max-w-md mx-auto">
            <div>
                <p class="text-xs text-gray-500 uppercase tracking-widest">Grand Total</p>
                <p class="text-xl font-black">{{totalAmount.toLocaleString()}} <span class="text-sm">KRW</span></p>
            </div>
            <div class="text-right">
                <p class="text-xs text-green-600 font-bold">退稅: -{{taxRefund.toLocaleString()}}</p>
                <p class="text-sm font-bold text-red-600">實付: {{ (totalAmount - taxRefund).toLocaleString() }}</p>
            </div>
        </div>

        <div v-if="modal" class="fixed inset-0 bg-black/50 flex items-center justify-center p-6 z-[100]">
            <div class="bg-white w-full rounded-xl p-4">
                <h3 class="font-bold mb-2">加入到 {{modalType === 'cart' ? '購物籃' : '計劃'}}</h3>
                <label class="text-sm">規格：</label>
                <select v-model="modalData.spec" class="w-full border p-2 mb-2">
                    <option v-for="s in modalData.item.specs" :value="s">{{s}}</option>
                </select>
                <label class="text-sm">數量：</label>
                <input type="number" v-model="modalData.qty" class="w-full border p-2 mb-4">
                <div v-if="modalType === 'plan'" class="mb-4">
                    <label class="text-sm">選擇計劃：</label>
                    <select v-model="modalData.targetPlanId" class="w-full border p-2">
                        <option v-for="p in plans" :value="p.id">{{p.name}}</option>
                    </select>
                </div>
                <div class="flex gap-2">
                    <button @click="modal = false" class="flex-1 bg-gray-200 py-2 rounded">取消</button>
                    <button @click="confirmModal" class="flex-1 bg-red-500 text-white py-2 rounded">確認</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    view: 'reg',
                    cartSubView: 'current',
                    search: '',
                    filterCat: '',
                    categories: ['護膚品', '化妝品', '零食', '文具', '生活雜貨', '其他'],
                    priceOptions: [500, 1000, 1500, 2000, 3000, 5000],
                    levels: ['想買', '需要', '必買'],
                    form: { name: '', category: '其他', price: 1000, img: '', level: '想買', specs: ['標準'] },
                    products: [],
                    plans: [],
                    cart: [],
                    history: [],
                    modal: false,
                    modalType: '',
                    modalData: { item: null, spec: '', qty: 1, targetPlanId: null },
                    // 退稅表數據 (簡化對應圖片)
                    taxTable: [
                        {min: 15000, max: 29999, ref: 1000},
                        {min: 30000, max: 49999, ref: 2000},
                        {min: 50000, max: 74999, ref: 3000},
                        {min: 75000, max: 99999, ref: 5000},
                        {min: 100000, max: 124999, ref: 7000},
                        {min: 125000, max: 149999, ref: 8000},
                        {min: 150000, max: 174999, ref: 9000},
                        {min: 175000, max: 199999, ref: 10000},
                        {min: 200000, max: 224999, ref: 12000}
                        // ... 程式中會用邏輯模擬其餘部分或完整手打
                    ]
                }
            },
            computed: {
                filteredProducts() {
                    return this.products.filter(p => {
                        const mSearch = p.name.includes(this.search);
                        const mCat = this.filterCat ? p.category === this.filterCat : true;
                        return mSearch && mCat;
                    });
                },
                totalAmount() {
                    return this.cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
                },
                taxRefund() {
                    const amt = this.totalAmount;
                    if (amt < 15000) return 0;
                    // 模擬圖片中的退稅階梯
                    const match = this.taxTable.find(t => amt >= t.min && amt <= t.max);
                    if (match) return match.ref;
                    // 超過表定範圍的估算 (約 6-7%)
                    return Math.floor(amt * 0.065);
                }
            },
            methods: {
                saveProduct() {
                    const newProd = { ...this.form, id: Date.now() };
                    this.products.push(newProd);
                    this.save();
                    alert('登記成功！');
                    this.view = 'list';
                },
                editProduct(item) {
                    this.form = { ...item };
                    this.view = 'reg';
                },
                addToPlanPrompt(item) {
                    if (this.plans.length === 0) { alert('請先在計劃頁建立一個清單'); return; }
                    this.modalType = 'plan';
                    this.modalData = { item, spec: item.specs[0], qty: 1, targetPlanId: this.plans[0].id };
                    this.modal = true;
                },
                addToCartPrompt(item) {
                    this.modalType = 'cart';
                    this.modalData = { item, spec: item.specs[0], qty: 1 };
                    this.modal = true;
                },
                confirmModal() {
                    const { item, spec, qty, targetPlanId } = this.modalData;
                    if (this.modalType === 'cart') {
                        this.addToCartLogic(item, spec, qty);
                    } else {
                        const plan = this.plans.find(p => p.id === targetPlanId);
                        plan.items.push({ id: item.id, name: item.name, spec, qty, price: item.price });
                    }
                    this.modal = false;
                    this.save();
                },
                addToCartLogic(item, spec, qty) {
                    // 合併邏輯：同 ID 且 同規格
                    const existing = this.cart.find(c => c.id === item.id && c.spec === spec);
                    if (existing) {
                        existing.qty += parseInt(qty);
                    } else {
                        this.cart.push({ id: item.id, name: item.name, spec, qty: parseInt(qty), price: item.price });
                    }
                },
                movePlanToCart(plan, pi, idx) {
                    this.addToCartLogic(pi, pi.spec, pi.qty);
                    plan.items.splice(idx, 1);
                    this.save();
                },
                createPlan() {
                    const name = prompt('輸入清單名稱', '購物清單 ' + (this.plans.length + 1));
                    if (name) this.plans.push({ id: Date.now(), name, items: [] });
                    this.save();
                },
                deletePlan(id) {
                    this.plans = this.plans.filter(p => p.id !== id);
                    this.save();
                },
                checkout() {
                    const record = {
                        id: Date.now(),
                        timestamp: new Date().toLocaleString(),
                        total: this.totalAmount,
                        items: [...this.cart]
                    };
                    this.history.unshift(record);
                    this.cart = [];
                    this.save();
                    alert('結帳成功，已存入歷史！');
                },
                deleteHistory(id) {
                    this.history = this.history.filter(h => h.id !== id);
                    this.save();
                },
                save() {
                    localStorage.setItem('daiso_data', JSON.stringify({
                        products: this.products,
                        plans: this.plans,
                        cart: this.cart,
                        history: this.history
                    }));
                },
                exportData() {
                    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(localStorage.getItem('daiso_data')));
                    const downloadAnchorNode = document.createElement('a');
                    downloadAnchorNode.setAttribute("href", dataStr);
                    downloadAnchorNode.setAttribute("download", "daiso_backup.json");
                    downloadAnchorNode.click();
                },
                clearCache() {
                    if (confirm('確定清除所有數據？')) {
                        localStorage.clear();
                        location.reload();
                    }
                }
            },
            mounted() {
                const cache = localStorage.getItem('daiso_data');
                if (cache) {
                    const d = JSON.parse(cache);
                    this.products = d.products || [];
                    this.plans = d.plans || [];
                    this.cart = d.cart || [];
                    this.history = d.history || [];
                }
            }
        }).mount('#app');
    </script>
</body>
</html>
